<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Products List</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>

  <body>
    <h1>üõí Products + üí± Rates</h1>

    <form id="form">
      <label>Limit:
        <input id="limit" type="number" min="1" value="10" />
      </label>
      <button type="submit">Fetch</button>
    </form>

    <div id="loading" class="hidden">‚è≥ Loading‚Ä¶</div>

    <div id="error" class="hidden">
      <span id="error-msg">‚ö†Ô∏è Something went wrong.</span>
      <button id="retry">Retry</button>
    </div>

    <div id="empty" class="hidden">üò∂ No products found.</div>

    <table id="table" class="hidden">
      <thead>
        <tr>
          <th>Title</th>
          <th>Category</th>
          <th>Product Description</th>
          <th>USD Price</th>
          <th>PHP Price</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <script>
      const form = document.getElementById('form');
      const limitInput = document.getElementById('limit');
      const rowsEl = document.getElementById('rows');

      const loadingEl = document.getElementById('loading');
      const errorEl   = document.getElementById('error');
      const errorMsg  = document.getElementById('error-msg');
      const emptyEl   = document.getElementById('empty');
      const tableEl   = document.getElementById('table');
      const retryBtn  = document.getElementById('retry');

      const show = el => el.classList.remove('hidden');
      const hide = el => el.classList.add('hidden');

      async function load() {

        show(loadingEl); hide(errorEl); hide(emptyEl); hide(tableEl);
        rowsEl.innerHTML = '';

        const limit = Number(limitInput.value || 10);

        try {
          const res = await fetch('/join?limit=' + encodeURIComponent(limit));

          let data = null;
          try { data = await res.json(); } catch (_) {}

          if (!res.ok) {
            const message = (data && data.error) ? data.error : '‚ö†Ô∏è Something went wrong.';
            errorMsg.textContent = message;
            hide(loadingEl); show(errorEl);
            return;
          }

          if (!data || !data.items || data.items.length === 0) {
            hide(loadingEl); show(emptyEl);
            return;
          }

          for (const p of data.items) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${p.title}</td>
              <td>${p.category}</td>
              <td>${p.description}</td>
              <td>$${Number(p.price_usd).toFixed(2)}</td>
              <td>‚Ç±${Number(p.price_php).toFixed(2)}</td>
            `;
            rowsEl.appendChild(tr);
          }

          hide(loadingEl); show(tableEl);

        } catch (_) {

          errorMsg.textContent = '‚ö†Ô∏è Network issue while fetching data. Please try again.';
          hide(loadingEl); show(errorEl);
        }
      }

      form.addEventListener('submit', (e) => { e.preventDefault(); load(); });
      retryBtn.addEventListener('click', () => load());

      load();
    </script>
  </body>
</html>
